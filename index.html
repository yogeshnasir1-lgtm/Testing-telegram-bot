<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рдХреНрд░рд┐рдкреНрдЯреЛ рдПрдХреНрд╕рдЪреЗрдВрдЬ - рд▓реЙрдЧрд┐рди рдФрд░ рд╕рд╛рдЗрдирдЕрдк</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* CSS: рдереЛрдбрд╝рд╛ рд╕рд╛ рд╕реНрдЯрд╛рдЗрд▓рд┐рдВрдЧ рддрд╛рдХрд┐ рдпрд╣ рд╕рд╛рдл рджрд┐рдЦреЗ */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 400px; margin: 0 auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #007bff; }
        .form-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        input[type="text"], input[type="password"] { width: 95%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #28a745; color: white; padding: 10px 15px; margin: 5px 0; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
        button:hover { opacity: 0.9; }
        .button-group button { background-color: #007bff; width: 48%; }
        .button-group button:last-child { background-color: #6c757d; }
        .message { margin-top: 15px; padding: 10px; border-radius: 4px; text-align: center; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ЁЯФС рдХреНрд░рд┐рдкреНрдЯреЛ рдПрдХреНрд╕рдЪреЗрдВрдЬ</h1>
        
        <div id="login-section" class="form-section">
            <h2>рд▓реЙрдЧрд┐рди</h2>
            <input type="text" id="login-number" placeholder="рдлрд╝реЛрди рдирдВрдмрд░" required><br>
            <input type="password" id="login-password" placeholder="рдкрд╛рд╕рд╡рд░реНрдб" required><br>
            
            <button onclick="handleLogin()">рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ</button>
            
            <div class="button-group" style="margin-top: 10px;">
                <button onclick="showSection('signup-section')" style="background-color: #17a2b8;">рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдБ</button>
                <button onclick="showSection('forgot-section')" style="background-color: #ffc107;">рдкрд╛рд╕рд╡рд░реНрдб рднреВрд▓ рдЧрдП</button>
            </div>
            
            <p id="login-message" class="message"></p>
        </div>

        <div id="signup-section" class="form-section hidden">
            <h2>рдирдпрд╛ рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдБ</h2>
            <input type="text" id="signup-name" placeholder="рдкреВрд░рд╛ рдирд╛рдо" required><br>
            <input type="text" id="signup-number" placeholder="рдлрд╝реЛрди рдирдВрдмрд░" required><br>
            <input type="password" id="signup-password" placeholder="рдкрд╛рд╕рд╡рд░реНрдб" required><br>
            
            <button onclick="handleSignup()" style="background-color: #28a745;">рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдБ</button>
            <button onclick="showSection('login-section')" style="background-color: #6c757d;">рд▓реЙрдЧрд┐рди рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдБ</button>
            
            <p id="signup-message" class="message"></p>
        </div>

        <div id="forgot-section" class="form-section hidden">
            <h2>рдкрд╛рд╕рд╡рд░реНрдб рд░реАрд╕реЗрдЯ</h2>
            <input type="text" id="forgot-number" placeholder="рдЕрдкрдирд╛ рдлрд╝реЛрди рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВ" required><br>
            
            <button onclick="handleForgotPassword()" style="background-color: #ffc107;">рд░реАрд╕реЗрдЯ рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ</button>
            <button onclick="showSection('login-section')" style="background-color: #6c757d;">рд▓реЙрдЧрд┐рди рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдБ</button>
            
            <p id="forgot-message" class="message"></p>
        </div>
    </div>
    
    
    <script>
        // --- Supabase Credentials (рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП) ---
        const SUPABASE_URL = 'https://lklzdnayllonhvwypeie.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrbHpkbmF5bGxvbmh2d3lwZWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDg5NzAsImV4cCI6MjA3OTQ4NDk3MH0.ZnNnPJE_8UUxkizxazXe-bo0m-DwGW57s9z5N4ROv3A';

        // Supabase Client рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░реЗрдВ
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- UI Helper Function ---
        function showSection(sectionId) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            // рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╕рд╛рдл рдХрд░реЗрдВ
            document.querySelectorAll('.message').forEach(msg => {
                msg.textContent = '';
                msg.classList.remove('success', 'error');
            });
        }
        
        // --- HELPER FUNCTIONS ---
        // 6-рдЕрдВрдХреАрдп рд╕рддреНрдпрд╛рдкрди рдХреЛрдб рдЬреЗрдирд░реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢рд┐рдВрдЧ (рдЙрддреНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рд╕рд░реНрд╡рд░-рд╕рд╛рдЗрдб Edge Function рдкрд░ рд▓реЗ рдЬрд╛рдПрдВ)
        async function hashPassword(password) {
            // рд╡рд░реНрддрдорд╛рди рдореЗрдВ, рд╕рд┐рд░реНрдл Plain Text рд░рд┐рдЯрд░реНрди рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддрд╛рдХрд┐ рд╣рдо Login/Signup рдЬрд╛рдВрдЪ рд╕рдХреЗрдВред
            return password; 
        }

        // --- 1. SIGNUP LOGIC ---
        async function handleSignup() {
            const name = document.getElementById('signup-name').value;
            const number = document.getElementById('signup-number').value;
            const password = document.getElementById('signup-password').value;
            const messageElement = document.getElementById('signup-message');

            if (!name || !number || !password) {
                messageElement.textContent = "рдХреГрдкрдпрд╛ рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗрдВред";
                messageElement.classList.add('error');
                return;
            }

            messageElement.textContent = "рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛ рд░рд╣рд╛ рд╣реИ, рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ...";
            messageElement.classList.remove('error', 'success');
            
            try {
                const hashedPassword = await hashPassword(password);
                
                // 1. 'users' рдЯреЗрдмрд▓ рдореЗрдВ рдирдпрд╛ рдпреВрдЬрд░ рд░рд┐рдХреЙрд░реНрдб рдбрд╛рд▓реЗрдВ
                const { data: newUser, error: userError } = await supabaseClient
                    .from('users')
                    .insert([
                        { 
                            name: name, 
                            phone_number: number, 
                            hashed_password: hashedPassword,
                            is_verified: false 
                        }
                    ])
                    .select('id') 
                    .single();

                if (userError) {
                    if (userError.code === '23505') { 
                        messageElement.textContent = "рдпрд╣ рдлрд╝реЛрди рдирдВрдмрд░ рдкрд╣рд▓реЗ рд╕реЗ рдкрдВрдЬреАрдХреГрдд рд╣реИред";
                    } else {
                        messageElement.textContent = `рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ${userError.message}`;
                    }
                    messageElement.classList.add('error');
                    return;
                }

                const userId = newUser.id;
                const verificationCode = generateVerificationCode();
                
                // 2. 'verification_codes' рдЯреЗрдмрд▓ рдореЗрдВ рд╕рддреНрдпрд╛рдкрди рдХреЛрдб рдбрд╛рд▓реЗрдВ (5 рдорд┐рдирдЯ рдХреА рд╕рдорд╛рдкреНрддрд┐)
                const now = new Date();
                const expiresAt = new Date(now.getTime() + 5 * 60000).toISOString(); 
                
                const { error: codeError } = await supabaseClient
                    .from('verification_codes')
                    .insert([
                        {
                            user_id: userId,
                            code: verificationCode,
                            type: 'signup',
                            expires_at: expiresAt
                        }
                    ]);

                if (codeError) {
                    messageElement.textContent = "рд╕рддреНрдпрд╛рдкрди рдХреЛрдб рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐ред";
                    messageElement.classList.add('error');
                    return;
                }

                // 3. рд╕рдлрд▓рддрд╛ рд╕рдВрджреЗрд╢ рдФрд░ рд╕рддреНрдпрд╛рдкрди рдЬрд╛рдирдХрд╛рд░реА рджрд┐рдЦрд╛рдПрдВ
                const telegramBotLink = "YOUR_TELEGRAM_BOT_LINK_HERE"; // **рдпрд╣ рд▓рд┐рдВрдХ рдмрджрд▓рдирд╛ рд╣реИ**
                
                messageElement.innerHTML = `
                    тЬЕ **рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкрдВрдЬреАрдХреГрдд!**<br>
                    рдЖрдкрдХрд╛ рд╕рддреНрдпрд╛рдкрди рдХреЛрдб рд╣реИ: <strong>${verificationCode}</strong><br>
                    рдХреГрдкрдпрд╛ <a href="${telegramBotLink}" target="_blank">Telegram Bot рдкрд░ рдЬрд╛рдПрдБ</a> рдФрд░ рдЗрд╕ рдХреЛрдб рдХреЛ рдкреЗрд╕реНрдЯ рдХрд░рдХреЗ рдЕрдХрд╛рдЙрдВрдЯ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВред
                `;
                messageElement.classList.add('success');
                
            } catch (err) {
                console.error("General Signup Error:", err);
                messageElement.textContent = "рдПрдХ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рддреНрд░реБрдЯрд┐ рд╣реБрдИред";
                messageElement.classList.add('error');
            }
        }
        
        // --- 2. LOGIN LOGIC ---
        async function handleLogin() {
            const number = document.getElementById('login-number').value;
            const password = document.getElementById('login-password').value;
            const messageElement = document.getElementById('login-message');

            if (!number || !password) {
                messageElement.textContent = "рдХреГрдкрдпрд╛ рдлрд╝реЛрди рдирдВрдмрд░ рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рджрд░реНрдЬ рдХрд░реЗрдВред";
                messageElement.classList.add('error');
                return;
            }

            messageElement.textContent = "рд▓реЙрдЧ рдЗрди рдХрд░ рд░рд╣рд╛ рд╣реИ, рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ...";
            messageElement.classList.remove('error', 'success');

            try {
                // 1. 'users' рдЯреЗрдмрд▓ рд╕реЗ рдпреВрдЬрд░ рдХреЛ Fetch рдХрд░реЗрдВ
                const { data: userData, error: fetchError } = await supabaseClient
                    .from('users')
                    .select('id, hashed_password, is_verified')
                    .eq('phone_number', number)
                    .single();

                if (fetchError || !userData) {
                    messageElement.textContent = "рдЧрд▓рдд рдлрд╝реЛрди рдирдВрдмрд░ рдпрд╛ рдкрд╛рд╕рд╡рд░реНрдбред";
                    messageElement.classList.add('error');
                    return;
                }

                // 2. рдкрд╛рд╕рд╡рд░реНрдб рдХреА рддреБрд▓рдирд╛ рдХрд░реЗрдВ (рдЙрддреНрдкрд╛рджрди рдореЗрдВ hashed password рдХреА рддреБрд▓рдирд╛ рдХрд░реЗрдВ!)
                if (userData.hashed_password !== password) {
                    messageElement.textContent = "рдЧрд▓рдд рдлрд╝реЛрди рдирдВрдмрд░ рдпрд╛ рдкрд╛рд╕рд╡рд░реНрдбред";
                    messageElement.classList.add('error');
                    return;
                }

                // 3. 'is_verified' рд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
                if (!userData.is_verified) {
                    messageElement.textContent = "рдЕрдХрд╛рдЙрдВрдЯ рд╕рддреНрдпрд╛рдкрд┐рдд рдирд╣реАрдВ рд╣реИред рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рдЕрдХрд╛рдЙрдВрдЯ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВред";
                    messageElement.classList.add('error');
                    return;
                }

                // 4. рд╕рдлрд▓рддрд╛: рд▓реЙрдЧрд┐рди рд╕рдлрд▓
                messageElement.innerHTML = `тЬЕ **рд▓реЙрдЧрд┐рди рд╕рдлрд▓!** рдбреИрд╢рдмреЛрд░реНрдб рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд░ рд░рд╣рд╛ рд╣реИ...`;
                messageElement.classList.add('success');
                
                // TODO: рдпрд╣рд╛рдБ рдпреВрдЬрд░ рдХреЛ рдПрдХреНрд╕рдЪреЗрдВрдЬ рдбреИрд╢рдмреЛрд░реНрдб (e.g., dashboard.html) рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд░реЗрдВ
                // window.location.href = 'dashboard.html'; 

            } catch (err) {
                console.error("Login Error:", err);
                messageElement.textContent = "рд▓реЙрдЧрд┐рди рдХрд░рддреЗ рд╕рдордп рдПрдХ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рддреНрд░реБрдЯрд┐ рд╣реБрдИред";
                messageElement.classList.add('error');
            }
        }
        
        // --- 3. FORGOT PASSWORD LOGIC ---
        async function handleForgotPassword() {
            const number = document.getElementById('forgot-number').value;
            const messageElement = document.getElementById('forgot-message');
            
            if (!number) {
                messageElement.textContent = "рдХреГрдкрдпрд╛ рдлрд╝реЛрди рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВред";
                messageElement.classList.add('error');
                return;
            }

            messageElement.textContent = "рд░реАрд╕реЗрдЯ рдХреЛрдб рднреЗрдЬ рд░рд╣рд╛ рд╣реИ...";
            messageElement.classList.remove('error', 'success');

            try {
                // 1. рдпреВрдЬрд░ рдХреЛ Fetch рдХрд░реЗрдВ
                const { data: userData, error: fetchError } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('phone_number', number)
                    .single();

                if (fetchError || !userData) {
                    messageElement.textContent = "рдпрд╣ рдлрд╝реЛрди рдирдВрдмрд░ рдкрдВрдЬреАрдХреГрдд рдирд╣реАрдВ рд╣реИред";
                    messageElement.classList.add('error');
                    return;
                }
                
                const userId = userData.id;
                const resetCode = generateVerificationCode();
                
                // 2. 'verification_codes' рдЯреЗрдмрд▓ рдореЗрдВ рдирдпрд╛ 'forgot' рдХреЛрдб рдбрд╛рд▓реЗрдВ
                const now = new Date();
                const expiresAt = new Date(now.getTime() + 5 * 60000).toISOString(); 

                const { error: codeError } = await supabaseClient
                    .from('verification_codes')
                    .insert([
                        {
                            user_id: userId,
                            code: resetCode,
                            type: 'forgot',
                            expires_at: expiresAt
                        }
                    ]);

                if (codeError) {
                    messageElement.textContent = "рд░реАрд╕реЗрдЯ рдХреЛрдб рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐ред";
                    messageElement.classList.add('error');
                    return;
                }
                
                // 3. рд╕рдлрд▓рддрд╛ рд╕рдВрджреЗрд╢ рджрд┐рдЦрд╛рдПрдВ
                const telegramBotLink = "YOUR_TELEGRAM_BOT_LINK_HERE"; // **рдпрд╣ рд▓рд┐рдВрдХ рдмрджрд▓рдирд╛ рд╣реИ**

                messageElement.innerHTML = `
                    тЬЕ **рд░реАрд╕реЗрдЯ рдХреЛрдб рднреЗрдЬрд╛ рдЧрдпрд╛!**<br>
                    рдЖрдкрдХрд╛ рд░реАрд╕реЗрдЯ рдХреЛрдб рд╣реИ: <strong>${resetCode}</strong><br>
                    рдХреГрдкрдпрд╛ <a href="${telegramBotLink}" target="_blank">Telegram Bot рдкрд░ рдЬрд╛рдПрдБ</a> рдФрд░ рдЗрд╕ рдХреЛрдб рдХреЛ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВред рдмреЙрдЯ рдЖрдкрдХреЛ рдирдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░рдиреЗ рджреЗрдЧрд╛ред
                `;
                messageElement.classList.add('success');
                
            } catch (err) {
                console.error("Forgot Password Error:", err);
                messageElement.textContent = "рдПрдХ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рддреНрд░реБрдЯрд┐ рд╣реБрдИред";
                messageElement.classList.add('error');
            }
        }


        // рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдХреЗрд╡рд▓ Login рд╕реЗрдХреНрд╢рди рджрд┐рдЦрд╛рдПрдВ
        window.onload = () => showSection('login-section');

    </script>
</body>
</html>
